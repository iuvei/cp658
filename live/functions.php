<?php//取得檔名function getSportFileName($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer.htm";            break;        case "nba":            return "nba.htm";            break;        default:            return "";    }}//取得檔名(有廣告)function getSportFileName_AD($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_ad.htm";            break;        case "nba":            return "nba_ad.htm";            break;        default:            return "";    }}//取得壓縮檔名function getSportZipFileName($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer.zip";            break;        case "nba":            return "nba.zip";            break;        default:            return "";    }}//取得壓縮檔名(有廣告)function getSportZipFileName_AD($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_ad.zip";            break;        case "nba":            return "nba_ad.zip";            break;        default:            return "";    }}//取得上次檔名function getLastSportFileName($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_last.htm";            break;        case "nba":            return "nba_last.htm";            break;        default:            return "";    }}//取得上次檔名(有廣告)function getLastSportFileName_AD($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_last_ad.htm";            break;        case "nba":            return "nba_last_ad.htm";            break;        default:            return "";    }}//取得上次壓縮檔名function getLastSportZipFileName($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_last.zip";            break;        case "nba":            return "nba_last.zip";            break;        default:            return "";    }}//取得上次壓縮檔名(有廣告)function getLastSportZipFileName_AD($sport){    switch (strtolower($sport)){        case "soccer":            return "soccer_last_ad.zip";            break;        case "nba":            return "nba_last_ad.zip";            break;        default:            return "";    }}//解壓縮檔function extractZipFile($sport){    $zip = new ZipArchive;    $zipfilename = getSportZipFileName($sport);    if (file_exists($zipfilename)){        if ($zip->open($zipfilename) === TRUE) {            $zip->extractTo('./');            $zip->close();            return true;        } else {            return false;        }    }else{        return false;    }}//解壓縮檔(有廣告)function extractZipFile_AD($sport){    $zip = new ZipArchive;    $zipfilename_ad = getSportZipFileName_AD($sport);    if (file_exists($zipfilename_ad)){        if ($zip->open($zipfilename_ad) === TRUE) {            $zip->extractTo('./');            $zip->close();            return true;        } else {            return false;        }    }else{        return false;    }}//從檔案取得資料，並移除廣告及其它無用訊息function getFilteredData($sport){    if (file_exists(getSportFileName($sport))){        $doc = new DOMDocument();        $doc->loadHTMLFile(getSportFileName($sport));        $xpath = new DOMXPath($doc);        switch (strtolower($sport)){            //足球            case "soccer":                $trs = $xpath->query('//tr[contains(@id,"tr_ad")]');                foreach ($trs as $tr){                    $tr->parentNode->removeChild($tr);                }                $tds = $xpath->query('//td[contains(@id,"other")]');                foreach ($tds as $td){                    $tr=$td->parentNode;                    $tr->parentNode->removeChild($tr);                }                $ads = $xpath->query('//td[contains(.,"广告")]');                foreach ($ads as $ad){                    $tr=$ad->parentNode;                    $tr->parentNode->removeChild($tr);                }                $trs = $xpath->query('//tr');                foreach ($trs as $tr){                    $tr->removeChild($tr->firstChild);                    $tr->removeChild($tr->lastChild);                }                return $doc->saveHTML();                break;            //籃球            case "nba":                $tables = $xpath->query('//table[contains(@id,"table_Ad")]');                foreach ($tables as $table){                    $table->parentNode->removeChild($table);                }                $trs = $xpath->query('//tr[contains(@id,"tr3_")]');                foreach ($trs as $tr){                    $tr->parentNode->removeChild($tr);                }                $checkboxes = $xpath->query('//input[contains(@id,"chk_")]');                foreach ($checkboxes as $checkbox){                    $checkbox->parentNode->removeChild($checkbox);                }                return $doc->saveHTML();                break;            default:                return "";        }        unset($doc);        unset($xpath);    }}//取得過濾後的原始碼(有廣告)function getFilteredData_AD($sport, $sourcehtml, $ad_url){    //內容來自檔案    if (trim($sourcehtml) === '' || empty($sourcehtml) || !isset($sourcehtml)) {        if (file_exists(getSportFileName_AD($sport))) {            $contents = file_get_contents(getSportFileName_AD($sport));            return filterData_AD($sport, $contents, $ad_url);        }    }    //內容來自參數    else {        return filterData_AD($sport, $sourcehtml, $ad_url);    }}//過濾原始碼，刪除或取代不要的資料(有廣告)function filterData_AD($sport, $sourcehtml, $ad_url){    $encoding = mb_detect_encoding($sourcehtml, array('ASCII','EUC-CN','BIG-5','UTF-8','GB2312'));    if ($encoding != false) {        $sourcehtml = iconv($encoding, 'UTF-8', $sourcehtml);    } else {        $sourcehtml = mb_convert_encoding($sourcehtml, 'UTF-8','Unicode');    }    $doc = new DOMDocument();    $doc->loadHTML('<meta http-equiv="content-type" content="text/html; charset=utf-8">' . $sourcehtml);    $xpath = new DOMXPath($doc);    switch (strtolower($sport)){        //足球        case "soccer":            $lqdels = $xpath->query("//*[@id='lqdel']");            foreach($lqdels as $lqdel){                $lqdel->parentNode->removeChild($lqdel);            }            $lqders = $xpath->query("//*[@id='lqder']");            foreach($lqders as $lqder){                $lqder->parentNode->removeChild($lqder);            }            $id_left_layers = $xpath->query("//*[@id='id_left_layer']");            foreach($id_left_layers as $id_left_layer){                $id_left_layer->parentNode->removeChild($id_left_layer);            }            $id_right_layers = $xpath->query("//*[@id='id_right_layer']");            foreach($id_right_layers as $id_right_layer){                $id_right_layer->parentNode->removeChild($id_right_layer);            }            //替換廣告            $ahrefs = $xpath->query('//a[contains(@href,\'http\')]');            foreach($ahrefs as $ahref) {                //echo $ahref->getAttribute('href') . '<br />';                if (!preg_match("#(.*?)win007.com#is",$ahref->getAttribute('href'))){                    $ahref->setAttribute('href', $ad_url);                }            }            $html = $doc->saveHTML();            //移除不必要的JavaScript            $html = preg_replace('#<script language="javascript" type="text/javascript" charset="gb2312" src="live.htm?(.*?)"></script>#is', '', $html);            $html = preg_replace('#<script language="javascript" src="http://guess.win007.com/users/header.aspx"></script>#is', '', $html);            $html = preg_replace('#<script type="text/javascript" charset="utf-8" src="vbsxml/sbOddsData.js?(.*?)">(.*?)</script>#is', '', $html);            $html = preg_replace('#<script type="text/javascript" charset="utf-8" src="vbsxml/sbCorner.js?(.*?)"></script>#is', '', $html);            //$html = preg_replace('#<script language="javascript" type="text/javascript" src="http://bf.win007.com/vbsxml/alias2.js"></script>#is', '', $html);            //$html = preg_replace('#<script language="javascript" type="text/javascript" src="common.js"></script>#is', '', $html);            //$html = preg_replace('#<script language="javascript" type="text/javascript" src="common2.js"></script>#is', '', $html);            //$html = preg_replace('#<script language="javascript" type="text/javascript" src="func.js"></script>#is', '', $html);            $html = preg_replace('#<script language="javascript" charset="gb2312" src="http://img2.win007.com/img/bottom.js"></script>#is', '', $html);            $html = preg_replace('#<script language="javascript" type="text/javascript" charset="gb2312" src="http://bf.win007.com/NewTop.js"></script>#is', '<script language="javascript" type="text/javascript" charset="gb2312" src="NewTop.js"></script>', $html);            $html = preg_replace('#vbsxml/detail.js#is', 'http://bf.win007.com/vbsxml/detail.js', $html);            $html = preg_replace('#vbsxml/panlu.js#is', 'http://bf.win007.com/vbsxml/panlu.js', $html);            $html = preg_replace('#<script type="text/javascript" charset="gb2312" src="vbsxml/bfdata.js(.*?)">(.*?)</script>#is', '', $html);            $html = preg_replace('#<iframe (.*?)src="http://win007bfcount.nowodds.com/count.html"(.*?)</iframe>#is', '', $html);            $html = preg_replace('#ShowTop30pxAD#is', '//ShowTop30pxAD', $html);            $html = preg_replace('#ShowBottomAd#is', '//ShowBottomAd', $html);            $html = preg_replace('#set_image_ad#is', '//set_image_ad', $html);            $html = preg_replace('#window.setTimeout\("LoadDetailFile\(\)",(.*?)1000\);#is', '//window.setTimeout("LoadDetailFile()", 1000);', $html);            $html = preg_replace('#window.setTimeout\("LoadSbDetailFile\(\)",(.*?)1000\);#is', '//window.setTimeout("LoadSbDetailFile()", 1000);', $html);            $html = preg_replace('#window.setTimeout\("LoadSbCornerFile\(\)",(.*?)1000\);#is', '//window.setTimeout("LoadSbCornerFile()", 1000);', $html);            $html = preg_replace('#window.setTimeout\("LoadPanluFile\(\)",(.*?)1000\);#is', '//window.setTimeout("LoadPanluFile()", 1000);', $html);            $html = preg_replace('#window.setTimeout\("gettime\(\)",(.*?)2000\);#is', '//window.setTimeout("gettime()", 2000);', $html);            $html = preg_replace('#window.setTimeout\("check\(\)"(.*?),(.*?)300000\);#is', '//window.setTimeout("check()" , 300000);', $html);            return $html;            break;        //籃球        case "nba":            $lqdel = $xpath->query("//*[@id='lqdel']");            $lqdel->parentNode->removeChild($lqdel);            $lqder = $xpath->query("//*[@id='lqder']");            $lqder->parentNode->removeChild($lqder);            return $doc->saveHTML();            break;        default:            return "";    }    unset($doc);    unset($xpath);}